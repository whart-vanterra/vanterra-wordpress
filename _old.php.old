<?php
/**
 * Plugin Name: _Vanterra Fluent Forms â€” First/Last Touch Tracking
 * Description: Adds first/last-touch attribution to a selected Fluent Form by reading 1st-party cookies set by attribution-tracker.js and populating hidden fields. Server-side backfill included.
 * Version: 0.1.0
 * Author: Will Hart
 * License: GPL2+
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

class VanterraFluentForms {
    
    public function __construct() {
        add_action('plugins_loaded', array($this, 'init'));
        register_activation_hook(__FILE__, array($this, 'activate'));
        register_deactivation_hook(__FILE__, array($this, 'deactivate'));
    }
    
    public function init() {
        // Check if Fluent Forms is active
        if (!class_exists('FluentForm\Framework\Foundation\Application')) {
            add_action('admin_notices', array($this, 'fluent_forms_missing_notice'));
            return;
        }
         
    }
    
    public function activate() {
        // Check if Fluent Forms is active
        if (!class_exists('FluentForm\Framework\Foundation\Application')) {
            deactivate_plugins(plugin_basename(__FILE__));
            wp_die('This plugin requires Fluent Forms to be installed and activated.');
        }
        
        $this->create_contact_form();
    }
    
    public function deactivate() {
        // Cleanup if needed
    }
    
    public function fluent_forms_missing_notice() {
        echo '<div class="error"><p>Vanterra Fluent Forms requires Fluent Forms to be installed and activated.</p></div>';
    }
    
    private function create_contact_form() {
        // Load the base form structure from JSON
        $base_form_path = plugin_dir_path(__FILE__) . 'base-form.json';
        if (!file_exists($base_form_path)) {
            return false;
        }
        
        $base_form_data = file_get_contents($base_form_path);
        $base_form = json_decode($base_form_data, true);
        
        if (!$base_form || !isset($base_form[0])) {
            return false;
        }
        
        $form_template = $base_form[0];
        $now = current_time('mysql');

        $form_data = [
            'title' => 'Will Form with Attribution Tracking',
            'form_fields' => wp_json_encode($form_template['form_fields'], JSON_UNESCAPED_SLASHES),
            // 'appearance_settings' => wp_json_encode($form_template['appearance_settings'] ?? [], JSON_UNESCAPED_SLASHES),
            'type' => 'form',
            'status' => 'published',
            'has_payment' => 0,
            'conditions' => null,
            'created_by' => get_current_user_id() ?: 1,
            'created_at' => $now,
            'updated_at' => $now,
        ];

        // Insert the form
        $form_id = wpFluent()->table('fluentform_forms')->insert($form_data);
        
        // if ($form_id) {
        //     // Insert form meta data
        //     if (isset($form_template['form_meta']) && is_array($form_template['form_meta'])) {
        //         foreach ($form_template['form_meta'] as $meta) {
        //             wpFluent()->table('fluentform_form_meta')->insert([
        //                 'form_id' => $form_id,
        //                 'meta_key' => $meta['meta_key'],
        //                 'value' => $meta['value']
        //             ]);
        //         }
        //     }
            
        //     update_option('vanterra_forms_contact_form_id', $form_id);
        // }
        
        return $form_id;
    }
 
}

// Initialize the plugin
new VanterraFluentForms();